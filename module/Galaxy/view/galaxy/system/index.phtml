<?php
$scale  = $config['scale'];
$offset = $config['offset'];
$max = $scale * $config['range'];
$radius  = round($config['range']/2); ?>

<div id="system">
<?= $this->partial('galaxy/partial/_switch_layer_display') ?>
<div class="hidden">
    <div id="data_xMin"><?= $system->x - $radius;?></div>
    <div id="data_xMax"><?= $system->x + $radius;?></div>
    <div id="data_yMin"><?= $system->y - $radius;?></div>
    <div id="data_yMax"><?= $system->y + $radius;?></div>
    <div id="data_offset"><?= $offset?></div>
    <div id="data_range"><?= $config['range']?></div>
    <div id="data_scale"><?= $scale?></div>
</div>
<div class="row-fluid">
<div class="span3 well sidebar-nav">
    <ul class="nav nav-list fleetList">
        <li class="nav-header">Eigene Flotten</li>
        <? foreach ($fleets as $fleet):
            if ($fleet['user_id'] == $userId):
        ?>
        <li id="fid-<?= $fleet['id']?>">
            <a title="(<?= $fleet['x'].','.$fleet['y'].','.$fleet['spot']?>)" href="#">
                <i class="icon-plane"></i> <?= $fleet['fleet'] ?>
            </a>
        </li>
        <? endif;
        endforeach; ?>
        <li class="nav-header">Fremde Flotten</li>
        <? foreach ($fleets as $fleet):
            if ($fleet['user_id'] != $userId):
        ?>
        <li id="fid-<?= $fleet['id']?>">
            <a title="(<?= $fleet['x'].','.$fleet['y'].','.$fleet['spot']?>)" href="#"><i class="icon-plane"></i> <?= $fleet['fleet'] ?></a>
        </li>
        <? endif;
        endforeach; ?>
        <li class="nav-header">Planeten/Monde</li>
        <? foreach ($objects as $o): ?>
        <li class="">
            <a href="#" title="(<?= $o['x'].','.$o['y'] ?>,0)"><i class="icon-globe"></i> <?= $o['name'] ?></a>
        </li>
        <? endforeach; ?>
    </ul>
</div><!--/span-->
<div class="span6">

<div id="parallax">
    <div id="systemBackground" class="parallax-layer" style="width:<?= $max ?>px;height:<?= $max ?>px;background-image: url(/image/<?= $system->background_image_url ?>);"></div>
    <div id="gridLayer" class="parallax-layer" style="width:<?= $max+200 ?>px;height:<?= $max+200 ?>px;background-image: url(/img/grid.gif)">
<?php
$m = $config['range'];
$r = round($m/2);

    $label = $system->x - $radius;
    for ($x=$offset; $x <=$max+$offset; $x=$x+$scale):
    if ($x%50 == 0):
    echo '<p class="debug" style="left: '.$x.'px; top:'.$offset.'px; border: 1px dotted grey;">'.$label.'</p>';
    $label = $label + 5;
    endif;
    endfor;
    $label = $system->y + $label%5;
    for ($y=$offset; $y<=$max+$offset; $y=$y+$scale):
    if ($y%50 == 0):
    $label = $label + 5;
    echo '<p class="debug" style="left: '.$offset.'px; top:'.$y.'px; border: 1px dotted grey;">'.$label.'</p>';
    endif;
    endfor;
?>
    </div>

    <div id="fleetsLayer" class="parallax-layer" style="width:<?= $max+200 ?>px;height:<?= $max+200 ?>px;">
    <? foreach ($fleets as $f):
        $left = round((($f['x'] + $r) % $m) * $scale) + $offset;
        $top  = round((($f['y'] + $r) % $m) * $scale) + $offset;
    if ($fleet['user_id'] == $userId):
        $color = '#0d0';
    else:
        $color = '#ddd';
    endif;
    ?>
        <div class="fleet" style="top:<?= $top?>px;left:<?= $left?>px;border: 1px dotted <?= $color ?>"> </div>
    <? endforeach; ?>
        <svg id="fleetsLayer-svg" height="100%" width="100%" style="position:absolute">
        <rect x="0" y="0" height="20" width="20" stroke="green" />
        <!-- svg content via javascript -->
        </svg>

        <div class="hidden">
        <?php foreach ($fleetOrders as $key => $order) :
            echo '<div id="'.$order->fleet_id.'-'.$order->tick.'" class="fleetorder">' . $order->coordinates . '</div>';
        endforeach;
        ?>
        </span>
    </div>

    <div id="systemLayer" class="parallax-layer" style="width:<?= $max+200 ?>px;height:<?= $max+200 ?>px;">

<?php
    // planets and moons:
    foreach ($objects as $p):

        $left = round((($p['x'] + $r) % $m) * $scale) + $offset;
        $top  = round((($p['y'] + $r) % $m) * $scale) + $offset;

        $colony_count = 0
        ?>
        <div style="position:absolute;line-height:10px;top:<?= $top?>px;left:<?= $left?>px">
            <img id="pid-<?= $p['id']?>" src="/img/<?= $p['image_url'] ?>" width="<?= $scale ?>" height="<?= $scale ?>" />
            <ul id="pid-<?= $p['id']?>-spots" class="dropdown-menu spots" role="menu" aria-labelledby="dLabel">
                <? foreach ($colonies as $cid => $colony):
                    if ($colony['system_object_id'] == $p['id']):
                        $colony_count += 1;
                ?>
                <li id="cid-<?= $cid ?>"><a tabindex="-1" href="#"><?= $colony['name'] ?></a></li>
                <?  endif;
                endforeach;
                if ($colony_count == 0): ?>
                <li><a tabindex="-1" href="#">keine Kolonien</a></li>
                <? endif ?>
            </ul>
        </div>
    <? endforeach ?>
    </div>
</div>
</div>
<div class="span3 well">
  <h4>Infos</h4>
  <form name="fleetActions" action="<?= $this->url('galaxy/default', array('controller'=>'fleet','action'=>'order'));?>" method="POST">
    <input type="hidden" name="fleetId" value="" />
    <input type="text" name="coords"  value="" style="background-color: transparent; border: 0" />
    <?php foreach ($colonies as $i => $c):
    $x = (int) $c['x'];
    $y = (int) $c['y'];
    $z = (int) $c['spot'];
    ?>
    <ul id="cid-<?= $c['id']?>-info" class="unstyled colonyInfos">
        <li>Kolonie: <?= $c['name']?></li>
        <li>Größe: </li>
        <li>Spieler: </li>
        <li>Punkte: </li>
        <li>Allianz: </li>
        <li class="hidden coords"><?= json_encode(array($x,$y,$z)) ?></li>
    </ul>
    <?php endforeach;?>

    <div id="fleetActions">
        <button type="submit" class="btn btn-large btn-block" name="order" value="move" >Bewegen</button>
        <button type="submit" class="btn btn-large btn-block" name="order" value="transport" >Transport</button>
        <button type="submit" class="btn btn-large btn-block" name="order" value="attack" >Angriff</button>
        <div class="error" style="display:none"></div>
    </div>
  </form>
</div>
</div><!--/row-->